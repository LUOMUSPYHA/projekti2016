{% extends "pyha/base.html" %}
{% block content %}
{% load i18n %}
	<div class="container-fluid">
		<div class="col-xs-12">
			<div class="page-header">
				<h1>{% trans "request_for_user" %}: {{userRequest.date|date:"d.m.Y    H:i"}}
					{% if userRequest.description and userRequest.description.strip %} 
						{{userRequest.description}}
						<button class= "btn btn-default btn-xs" data-toggle="collapse" data-target="#descriptionEdit" id="descriptionButton"><span class="glyphicon glyphicon-pencil"></span></button>
					{% else %}
					{% endif %}
				</h1>
				
				<!-- lomake kuvauksen muuttamiseen -->
				<div id="descriptionEdit" class="collapse" style="margin:20px 0 25px 0">
					<form class="form-inline" action="{% url 'pyha:description' %}" method="post" id ="description-form">
						<div class="form-group">
							
							<div class="col-12" style="clear: left;">
								<label for="description">{% trans "request_description" %}:</label>
							</div>
							
							<div class="col-12" style="clear: left;">
								{% if userRequest.description and userRequest.description.strip %}
									<textarea class="form-control" name = "description" id="description" rows="2" maxlength="200" style="width:50%;min-width:300px" >{{userRequest.description}}</textarea>
								{% else %} 
									<textarea class="form-control" name = "description" id="description" rows="2" maxlength="200" style="width:50%;min-width:300px" >{% trans "no_description" %}</textarea>
								{% endif %}
								<!--<input type="text" class="form-control" id="description" name="description" 
										value={{userRequest.description}} style="width: 300px;height: 50px"> -->
								<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
								<input type="hidden" id="next" name="next" value={{request.path}}>
							</div>
						
							<div class="col-12" style="clear: left;">
								<button type="submit" class="btn btn-default">{% trans "change" %}</button>
							</div>
							
							<p id="description" class="form-text text-muted">
							{% trans "A description is a voluntary way to name your request. Without it the requests title will be the requests date" %}.
							<!-- Kuvaus on vapaaehtoinen tapa nimetä pyyntö. Ilman sitä pyynnön otsikkona käytetään päiväystä, jolloin pyyntö on tehty. -->
							</p>
						</div>
						{% csrf_token %}
					</form>
				</div>
			</div>

			<!-- suodatinlista -->
			<h3>{% trans "request_filters" %}:</h3>

			<button class= "btn btn-default" data-toggle="collapse" data-target="#filterlist" id="filterbutton">{% trans "show" %}</button>
			<div id="filterlist" class="collapse">	

				{% if filters %}
					<table class = "table" style="width:100%">
						<tr style=color:black>
							<th>{% trans "filter" %}</th>
							<th>{% trans "values" %}</th>	
						</tr>	
						{% for filter in filters %}
						<tr>	
							<td rowspan={{filter.1|length}}>{{ filter.2 }}</td>
							{% for f in filter.1 %}
							<td>{{ f }}</td>
						</tr>
							<tr>
							{% endfor %}
							</tr>
						{% endfor %}
					</table>
				{% else %}
					<strong>{% trans "no_filters" %}.</strong>
				{% endif %}
			</div>
			
			<!-- aineistolista -->
			{% if collections %}
			<form action="{% url 'pyha:approve' %}" id="requestform" method="post">
				<div class="col-xs-12">
					<div class="row">
						<h2>{% trans 'approval_of_terms' %} </h2>
						<section>
							<div class="wizard">
								<div class="wizard-inner">
									<div class="connecting-line"></div>
									<ul class="nav nav-tabs" role="tablist">

										<li role="presentation" class="active">
											<a href="#step1" data-toggle="tab" aria-controls="step1" role="tab" title="{% trans 'sensitivity_tab' %}">
												<span class="round-tab">
													<i>1</i>
												</span>
											</a>
										</li>

										<li role="presentation" class="disabled">
											<a href="#step2" data-toggle="tab" aria-controls="step2" role="tab" title="{% trans 'collections_tab'%}">
												<span class="round-tab">
													<i>2</i>
												</span>
											</a>
										</li>

										<li role="presentation" class="disabled">
											<a href="#step3" data-toggle="tab" aria-controls="step3" role="tab" title="{% trans 'arguments_tab'%}">
												<span class="round-tab">
													<i>3</i>
												</span>
											</a>
										</li>

										<li role="presentation" class="disabled">
											<a href="#complete" data-toggle="tab" aria-controls="complete" role="tab" title="{% trans 'summary_tab'%}">
												<span class="round-tab">
													<i class="glyphicon glyphicon-ok"></i>
												</span>
											</a>
										</li>                
									</ul>
								</div>

								<form role="form">
									<div class="tab-content">
										<div class="tab-pane active" role="tabpanel" id="step1">
											<div class="form-group">
										{% if taxon %}
											<h3>{% trans "Request involves collections requiring approval for sensitive terms" %}:</h3>
											<button type="button" class="btn btn-default btn-s" data-toggle="collapse" data-target="#sensitiveInfo"><span class="glyphicon glyphicon-info-sign"></span></button>


												<div id="sensitiveInfo" class="collapse">
													<p>{more_sensitivity_info}</p>
												</div>

												<p></p>
												<table class="table" style="width:100%">
												<tr style=color:black>

												<th>{% trans "collection_for_user" %}</th>
												<th>{% trans "request_description" %}</th>
												<th>{% trans "sensitive_sightings" %}</th>
												<th></th>

												</tr>	
												{% for collection in taxonlist %}
												<tr style="border-	bottom:2px solid #456789">
													<td>{{collection.result.collectionName}}</td>
													<td>{{collection.result.description}}</td>
													<td>{{collection.taxonSecured}}</td>

												</tr>
												{% endfor %}
												</table>

												<div class="modal fade" id="myModalsens" tabindex="-1" role="dialog" aria-labelledby="sensiModalLabel">
													<div class="modal-lg modal-dialog" role="document">
														<div class="modal-content">
															<div class="modal-header">
																<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
																<h4 class="modal-title" id="myModalLabel">{% trans "sensitive_terms" %}</h4>
															</div>
															<div class="modal-body">
																{% load static %}
																	<object data= "{{ static }}pyha/ehdot.pdf" width="100%" height="700" type='application/pdf'>
																		<alt>{% trans "If_you_cannot_see_terms_you_can_load_them" %} <a href="{{ static }}pyha/ehdot.pdf">{% trans "here" %}</a></alt>
																		<embed src= "{{ static }}pyha/ehdot.pdf" width="100%" height="700" type='application/pdf'>
																	</object>
												
															  </div>
															<div class="modal-footer">
																<input type="checkbox" id ="checkbsens" name="checkb" value="sens" onchange="checksens(); checkForApproval();">
																{% trans "i_accept_terms" %}<br>
																<p></p>
																<button type="button" class="btn btn-default" data-dismiss="modal" id=>{% trans "exit" %}</button>
															</div>
														</div>
													</div>
												</div>
												<ul class="list-inline pull-right">

												<button type="button" class="btn btn-default" required data-toggle="modal" data-target="#myModalsens">{% trans "terms" %}</button>
												{% else %}
												<h3>{% trans "no_sensitive_sightings_go_to_step_2" %}.</h3>
												{% endif %}
												<ul class="list-inline pull-right">               
													<li><span id ="statustextsens">{% trans "you_have_not_accepted_terms" %}</span></li>
													<li><button type="button" class="btn btn-primary next-step">{% trans 'continue_to_step_2' %}</button></li>
											</ul>
											<script>checksens();</script>
											</div>
										</div> 

										<div class="tab-pane" role="tabpanel" id="step2">
										{% if custom %}
											<h3>{% trans "secured_collections_in_request" %}:</h3>
												<table class="table" style="width:100%">
													<tr style=color:black>				
														<th>{% trans "collection_for_user" %}</th>
														<th>{% trans "request_description" %}</th>
														<th>{% trans "sightings_secured_by_data_provider" %}</th>
														<th></th>
														<th>{% trans "terms_of_collection_use" %}</th>
														<th>{% trans "request_status_for_user" %}</th>
													</tr>
													{% for collection in customlist %}
													<tr>
														<td>{{collection.result.collectionName}}
														<td>{{collection.result.description}}</td>
														<td>{{collection.customSecured}}</td>
														<td>
															<!-- Remove collection which sightings not willing to accept-->
															<div class="deleteContainer">
																<button class="removeCollectionButton" id="form{{ forloop.counter0 }}" type="button" ><span class="glyphicon glyphicon-trash"></span></button>
																{% trans "Delete_this_collection" %}
															</div>
														</td>

														<td><button type="button" class="btn btn-default btn-sm" required data-toggle="modal" data-target="#myModal{{ forloop.counter0 }}">{% trans "terms" %}</button></td>
														<td><span id ="statustext{{ forloop.counter0 }}">{% trans "you_have_not_accepted_terms" %}</span></td> 
											
														<!-- Modal -->
														<div class="modal fade" id="myModal{{ forloop.counter0 }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
															<div class="modal-lg modal-dialog" role="document">
																<div class="modal-content">
																	<div class="modal-header">
																		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
																		<h4 class="modal-title" id="myModalLabel">{% trans "sensitive_terms" %}</h4>
																	</div>
																<div class="modal-body">
																{% load static %}
																	<object data= "{{ static }}pyha/ehdot.pdf" width="100%" height="700" type='application/pdf'>
																		<alt>{% trans "If_you_cannot_see_terms_you_can_load_them" %} <a href="{{ static }}pyha/ehdot.pdf">{% trans "here" %}</a></alt>
																		<embed src= "{{ static }}pyha/ehdot.pdf" width="100%" height="700" type='application/pdf'>
																	</object>
																</div>
																	<div class="modal-footer">
																		<input type="checkbox" id ="checkb{{forloop.counter0}}" name="checkb" value="{{collection.result.id}}"
																		onchange="check({{ forloop.counter0 }}); checkForApproval();">
																		{% trans "I have read and understood the terms" %}<br>
																		<p></p>
																		
																		<button type="button" class="btn btn-default" data-dismiss="modal" id=>{% trans "exit" %}</button>
																	</div>
																</div>
															</div>
														</div>
														
														
													</tr>
													{% endfor %}
												</table>
											{% else %}
											<h3>{% trans "no_custom_secure_reasons_continue_to_step_3"%}</h3>
											{% endif %}
											<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
											<ul class="list-inline pull-right">
												<li><button type="button" class="btn btn-default prev-step">{% trans 'previous'%}</button></li>
												<li><button type="button" class="btn btn-primary next-step">{%trans 'continue_to_step_3'%}</button></li>
											</ul>
										</div>

											<div class="tab-pane" role="tabpanel" id="step3">
												<h3>{% trans "request_arguments_for_user" %}:</h3>
												<textarea class="form-control" rows="2" id="reason" name="reason" required placeholder="{% trans 'required_arguments' %}"></textarea>
												<ul class="list-inline pull-right">
													<li><button type="button" class="btn btn-default prev-step">{% trans 'previous'%}</button></li>
													<li><button id="continue-to-summary" type="button" class="btn btn-primary btn-info-full next-step" disabled=true>{% trans 'continue'%}</button></li>
												</ul>
											</div>
											<div class="tab-pane" role="tabpanel" id="complete">
												

												<div id="collections_not_approved">
												<h3>{% trans "you_havent_accepted_the_following_collections" %}:</h3>
												
												<ul>
												{% for collection in collections%}
													<li id="acc{{forloop.counter0}}"> {{collection.result.collectionName}} </li>
													<script>check({{forloop.counter0}});</script>
												{% endfor %}
												</ul>
												<p>{% trans "accept_the_terms_or_delete_the_collections_to_proceed" %}.</p>
												</div>
												<h3>{% trans "you_are_requestion_data_from_the_following_collections" %}</h3>
												<ul>
												{% for collection in collections%}
													<li> {{collection.result.collectionName}} </li>
												{% endfor %}
												</ul>

												<ul class="list-inline pull-right">
													<li><button type="submit" id="submit" class="btn btn-success">{% trans "send_to_be_accepted" %}</button></li>
													<li>
												<span id ="submitstatustext">{% trans "you_have_to_accept_or_delete_all_terms" %}</span></li>
												<script>checkForApproval();</script>

												</ul>
											</div>
										<div class="clearfix"></div>
									</div>
										{% csrf_token %}
								</form>
							</div>
						</section>
					</div>
				</div>
			</form>
        </div>
		{% else %}
			<strong> {% trans "no_collections_for_requests" %}.</strong>
		{% endif %}
	</div>
						<!--- hidden confirm modal --->
					<div id="confirm-modal" class="modal fade modal-sm modal-confirm" >
						<div class="modal-content" >
							<div class="modal-header">
							</div>
							<div class="modal-body">
								{% trans "are_you_sure_you_want_to_remove_collection" %}
							</div>
							<div class="modal-footer">
								<button type="button" data-dismiss="modal" class="btn btn-danger" id="delete">{% trans "delete" %}</button>
								<button type="button" data-dismiss="modal" class="btn btn-outline-secondary">{% trans "back" %}</button>
							</div>
						</div>
					</div>
					{% if collections %} 
					<!-- hidden delete collection forms -->
						{% for collection in collections %}
					<form class="form-hidden" action="/pyha/removeCollection" id="deleteform{{ forloop.counter0 }}" method="post">
						<div class="form-group">
							<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
							<input type="hidden" id="collectionid" name="collectionid" value={{collection.address}}>
							<input type="hidden" id="next" name="next" value={{request.path}}>
							<input type="submit" class="btn" value="submit!" name="psubmit" Style="display: none;"></button>
						{% csrf_token %}
						</div>
					</form>
					<!-- delete sensitive data -->
					<form class="form-hidden" action="/pyha/removeSens" id="deletesensform{{ forloop.counter0 }}" method="post">
						<div class="form-group">
							<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
							<input type="hidden" id="collectionId" name="collectionId" value={{collection.id}}>
							<input type="hidden" id="next" name="next" value={{request.path}}>
							<input type="submit" class="btn" value="submit!" name="psubmit" Style="display: none;"></button>
						</div>
						{% csrf_token %}

					<!--  delete custom data -->
					</form>
					<form class="form-hidden" action="/pyha/removeCustom" id="deletecustomform{{ forloop.counter0 }}" method="post">
						<div class="form-group">
							<input type="hidden" id="requestid" name="requestid" value={{userRequest.id}}>
							<input type="hidden" id="collectionId" name="collectionId" value={{collection.id}}>
							<input type="hidden" id="next" name="next" value={{request.path}}>
							<input type="submit" class="btn" value="submit!" name="psubmit" Style="display: none;"></button>
						</div>
					{% csrf_token %}

					</form>
						{% endfor %}
					{% endif %}
{% endblock %}

{% block start_script %}

	<script>
	  var accepted = [];
	  var acceptedsens = 0;
	  function checksens() { 
		  approvetext = "{% trans 'you_accepted_terms' %}";
		  nonapprovetext = "{% trans 'you_have_not_accepted_terms' %}";
		  if(document.getElementById('checkbsens').checked){
			  document.getElementById('statustextsens').textContent=approvetext;
			  acceptedsens = 1;
		  }else{
			  document.getElementById('statustextsens').textContent=nonapprovetext;
			  acceptedsens = 0;
		}
	  }
	  function check(counter) { 
		  approvetext = "{% trans 'you_accepted_terms' %}";
		  nonapprovetext = "{% trans 'you_have_not_accepted_terms' %}";
		  if(document.getElementById('checkb'+ counter).checked){
			  document.getElementById('statustext'+ counter).textContent=approvetext;
			  document.getElementById('acc' + counter).hidden = true
			  accepted[counter] = 1;
		  }else{
			  document.getElementById('statustext'+ counter).textContent=nonapprovetext;
			  document.getElementById('acc' + counter).hidden = false
			  accepted[counter] = 0;
		}
	  }
	  function checkv(counter, value) { 
		  accepted[counter] = value;
	  }
	  function checkForApproval(){
		var approved = 0;
		for (i = 0; i < accepted.length; i++){
			approved += accepted[i];
		}
		approved += acceptedsens;
		if(approved == accepted.length + 1){
			document.getElementById('submit').disabled = false;
			document.getElementById('submitstatustext').hidden = true;
			document.getElementById('collections_not_approved').hidden = true;
		}else{
			document.getElementById('submit').disabled = true;
			document.getElementById('submitstatustext').hidden = false;
			document.getElementById('collections_not_approved').hidden = false;
		}
	  }
	  

	</script>
	

	
	<script>
	$(document).ready(function(){
	  $("#filterlist").on("hide.bs.collapse", function(){
		$("#filterbutton").html('Näytä');
	  });
	  $("#filterlist").on("show.bs.collapse", function(){
		$("#filterbutton").html('Piilota');
	  });
	});
	</script>
	
	
	
	<script>
	
	
	
	</script>
{% endblock %}
{% block end_script %}
	<script>
		$('.deleteContainer').on('click',function(e){
			var name ="#delete" + $(this).find('.removeCollectionButton').attr('id');
			e.preventDefault();
			$('#confirm-modal').off()
			$('#confirm-modal').modal({backdrop: 'static', keyboard: false})
				.one('click', '#delete', function(){
					$(name).submit();
			});
			
		});
		$('.sensDeleteContainer').on('click',function(e){
			var name = "#deletesens" + $(this).find('.removeSensitiveButton').attr('id');
			e.preventDefault();
			$('#confirm-modal').off()
			$('#confirm-modal').modal({backdrop: 'static', keyboard: false})
				.one('click', '#delete', function(){
					$(name).submit();
			});

		});
		$('.customDeleteContainer').on('click',function(e){
			var name = "#deletecustom" + $(this).find('.removeCustomButton').attr('id');
			e.preventDefault();
			$('#confirm-modal').off()
			$('#confirm-modal').modal({backdrop: 'static', keyboard: false})
				.one('click', '#delete', function(){
					$(name).submit();
			});
		});
	</script>

	<script>
	<!-- näytä kuvauksen muokkaus elementti jos kuvauksen pituus on 0 -->
	$(document).ready(function(){
		var descExists = {{ userRequest.description.strip|length }};
		if (descExists == 0) {
			$("#descriptionEdit").show();
		}
	});
	</script>
	
	<!-- oma scripti kuvauksen muokkausnapille show/hide -->
	<script>
	$(document).ready(function(){
	  $("#descriptionEdit").on("hide.bs.collapse", function(){
		$("#descriptionButton").html('<span class="glyphicon glyphicon-pencil"></span>');
	  });
	  $("#descriptionEdit").on("show.bs.collapse", function(){
		$("#descriptionButton").html('Piilota');
	  });
	});
	</script>
{% endblock %}
{% block modal %}
{% endblock %}
